<view class="page" data-weui-theme="{{theme}}">
  <view class="container">
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading-container">
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- é”™è¯¯çŠ¶æ€ -->
    <view wx:elif="{{error}}" class="error-container">
      <text class="error-text">è·å–å†…å®¹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</text>
      <button class="retry-btn" bindtap="retry">é‡è¯•</button>
    </view>

    <!-- å†…å®¹å±•ç¤º -->
    <view wx:else class="article-container">
      <!-- åª’ä½“æ¨ªå‘æ»šåŠ¨åŒºåŸŸï¼ˆæœ€ä¸Šæ–¹ï¼ŒåŒ…å«å›¾ç‰‡å’Œè§†é¢‘ï¼‰ -->
      <view wx:if="{{parsedImages && parsedImages.length > 0}}" class="images-gallery-section">
        <swiper 
          class="images-gallery-swiper"
          current="{{currentImageIndex}}"
          bindchange="onImageSwiperChange"
          indicator-dots="{{false}}"
          autoplay="{{false}}"
          circular="{{false}}"
          duration="{{300}}"
        >
          <block wx:for="{{parsedImages}}" wx:key="index" wx:for-index="imgIndex">
            <swiper-item class="images-gallery-swiper-item">
              <!-- å›¾ç‰‡ -->
              <view wx:if="{{item.type === 'image'}}" class="images-gallery-item">
                <image 
                  class="images-gallery-image"
                  src="{{item.url}}"
                  mode="aspectFill"
                  bindtap="previewImageFromGallery"
                  data-url="{{item.url}}"
                  data-index="{{imgIndex}}"
                  show-menu-by-longpress="{{true}}"
                ></image>
              </view>
              <!-- è§†é¢‘ -->
              <view wx:elif="{{item.type === 'video'}}" class="images-gallery-item images-gallery-video-item">
                <video 
                  id="gallery-video-{{imgIndex}}"
                  class="images-gallery-video"
                  src="{{item.src}}"
                  poster="{{item.poster || ''}}"
                  controls="{{true}}"
                  show-center-play-btn="{{true}}"
                  enable-play-gesture="{{true}}"
                  object-fit="contain"
                  lazy-load="{{true}}"
                  initial-time="{{0}}"
                  autoplay="{{currentImageIndex === imgIndex}}"
                  bindplay="onVideoPlay"
                  bindpause="onVideoPause"
                  binderror="onVideoError"
                  data-index="{{imgIndex}}"
                ></video>
              </view>
            </swiper-item>
          </block>
        </swiper>
        <view wx:if="{{parsedImages.length > 1}}" class="images-gallery-indicator">
          <text class="images-gallery-indicator-text">{{currentImageIndex + 1}} / {{parsedImages.length}}</text>
        </view>
      </view>
      
      <!-- å‘åå…¼å®¹ï¼šå¦‚æœæ²¡æœ‰è§£æå›¾ç‰‡ï¼Œæ˜¾ç¤ºæ—§ç‰ˆå›¾ç‰‡åˆ—è¡¨ -->
      <view wx:elif="{{images && images.length > 0 && (!parsedContent || parsedContent.length === 0)}}" class="images-gallery-section">
        <swiper 
          class="images-gallery-swiper"
          current="{{currentImageIndex}}"
          bindchange="onImageSwiperChange"
          indicator-dots="{{false}}"
          autoplay="{{false}}"
          circular="{{false}}"
          duration="{{300}}"
        >
          <block wx:if="{{images}}" wx:for="{{images}}" wx:key="*this" wx:for-index="index">
            <swiper-item class="images-gallery-swiper-item">
              <view class="images-gallery-item">
                <image 
                  class="images-gallery-image"
                  src="{{item}}"
                  mode="aspectFill"
                  bindtap="previewImage"
                  data-url="{{item}}"
                  data-index="{{index}}"
                  show-menu-by-longpress="{{true}}"
                ></image>
              </view>
            </swiper-item>
          </block>
        </swiper>
        <view wx:if="{{images.length > 1}}" class="images-gallery-indicator">
          <text class="images-gallery-indicator-text">{{currentImageIndex + 1}} / {{images.length}}</text>
        </view>
      </view>

      <!-- æ­£æ–‡å†…å®¹åŒºåŸŸ -->
      <view class="content-section">
        <!-- ä½¿ç”¨è§£æåçš„èŠ‚ç‚¹æ•°ç»„è¿›è¡Œå†…è”æ¸²æŸ“ï¼ˆåªæ˜¾ç¤ºæ–‡æœ¬ã€é“¾æ¥ï¼Œä¸æ˜¾ç¤ºå›¾ç‰‡å’Œè§†é¢‘ï¼‰ -->
        <view wx:if="{{parsedContent && parsedContent.length > 0}}" class="article-content-parsed">
          <block wx:if="{{parsedContent}}" wx:for="{{parsedContent}}" wx:key="index" wx:for-index="nodeIndex" wx:for-item="node">
            <!-- æ–‡æœ¬èŠ‚ç‚¹ -->
            <rich-text wx:if="{{node.type === 'text'}}" class="article-text-node" nodes="{{node.content}}" selectable="{{true}}"></rich-text>
            
            <!-- è§†é¢‘èŠ‚ç‚¹ - å·²åœ¨é¡¶éƒ¨è½®æ’­ä¸­æ˜¾ç¤ºï¼Œæ­£æ–‡ä¸­ä¸æ˜¾ç¤º -->
            
            <!-- é“¾æ¥èŠ‚ç‚¹ -->
            <view wx:elif="{{node.type === 'link'}}" class="article-link-node">
              <view class="inline-link-item" bindtap="copyLink" data-url="{{node.url}}">
                <text class="inline-link-icon">ğŸ”—</text>
                <text class="inline-link-text">{{node.text}}</text>
                <text class="inline-link-hint">ç‚¹å‡»å¤åˆ¶</text>
              </view>
            </view>
          </block>
        </view>
        
        <!-- å‘åå…¼å®¹ï¼šå¦‚æœæ²¡æœ‰è§£æåçš„å†…å®¹ï¼Œä½¿ç”¨åŸæ¥çš„ rich-text -->
        <rich-text wx:else class="article-content" nodes="{{content}}" selectable="{{true}}"></rich-text>
      </view>

      <!-- åœ°ç‚¹å’Œå‘å¸ƒæ—¶é—´ä¿¡æ¯ -->
      <view class="meta-section">
        <!-- åœ°ç‚¹ä¿¡æ¯ -->
        <view wx:if="{{location && location.address}}" class="meta-location" bindtap="openLocation">
          <text class="location-icon">ğŸ“</text>
          <text class="location-text">{{location.address}}</text>
        </view>
        
        <!-- å‘å¸ƒæ—¶é—´ -->
        <view wx:if="{{meta}}" class="meta-time-row">
          <text class="meta-time">{{meta}}</text>
          <text wx:if="{{views > 0}}" class="meta-views">{{formattedViews}} æµè§ˆ</text>
        </view>
      </view>

      <!-- æ–‡ç« è§†é¢‘åŒºåŸŸ - å·²ç§»é™¤ï¼Œè§†é¢‘åªåœ¨é¡¶éƒ¨è½®æ’­æ˜¾ç¤º -->
      <!-- è§†é¢‘å·²åœ¨é¡¶éƒ¨è½®æ’­åŒºåŸŸæ˜¾ç¤ºï¼Œä¸å†åœ¨æ­£æ–‡ä¸‹æ–¹æ˜¾ç¤º -->

      <!-- è¯„è®ºåŒº -->
      <view class="comments-section">
        <view class="comments-header">
          <text class="comments-title">è¯„è®º</text>
          <text class="comments-count">{{commentsCount || 0}}</text>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view wx:if="{{comments && comments.length > 0}}" class="comments-list">
          <block wx:for="{{comments}}" wx:key="id" wx:for-item="comment" wx:for-index="commentIndex">
            <!-- æ ¹è¯„è®º -->
            <view class="comment-item comment-root">
              <view class="comment-avatar">
                <text class="comment-avatar-emoji">{{comment.avatarEmoji || 'ğŸ‘¤'}}</text>
              </view>
              <view class="comment-content">
                <view class="comment-header">
                  <text class="comment-author">{{comment.author || 'åŒ¿åç”¨æˆ·'}}</text>
                  <text class="comment-time">{{comment.time || ''}}</text>
                </view>
                <view class="comment-text">{{comment.content}}</view>
                <view class="comment-actions">
                  <view class="comment-action-btn" bindtap="likeComment" data-comment-id="{{comment.id}}">
                    <text class="comment-action-icon">{{comment.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                    <text class="comment-action-count">{{comment.likes || 0}}</text>
                  </view>
                  <view class="comment-action-btn" bindtap="replyComment" data-comment-id="{{comment.id}}" data-index="{{commentIndex}}">
                    <text class="comment-action-icon">ğŸ’¬</text>
                    <text class="comment-action-text">å›å¤</text>
                  </view>
                </view>
                
                <!-- å›å¤åˆ—è¡¨ -->
                <view wx:if="{{comment.replies && comment.replies.length > 0}}" class="comment-replies">
                  <block wx:for="{{comment.replies}}" wx:key="id" wx:for-item="reply" wx:for-index="replyIndex">
                    <view class="comment-item comment-reply">
                      <view class="comment-avatar comment-reply-avatar">
                        <text class="comment-avatar-emoji">{{reply.avatarEmoji || 'ğŸ‘¤'}}</text>
                      </view>
                      <view class="comment-content">
                        <view class="comment-header">
                          <text class="comment-author">{{reply.author || 'åŒ¿åç”¨æˆ·'}}</text>
                          <text class="comment-time">{{reply.time || ''}}</text>
                        </view>
                        <view class="comment-text">{{reply.content}}</view>
                        <view class="comment-actions">
                          <view class="comment-action-btn" bindtap="likeComment" data-comment-id="{{reply.id}}" data-is-reply="true" data-parent-id="{{comment.id}}">
                            <text class="comment-action-icon">{{reply.liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
                            <text class="comment-action-count">{{reply.likes || 0}}</text>
                          </view>
                          <view class="comment-action-btn" bindtap="replyComment" data-comment-id="{{reply.id}}" data-parent-id="{{reply.parentId || comment.id}}" data-index="{{commentIndex}}">
                            <text class="comment-action-icon">ğŸ’¬</text>
                            <text class="comment-action-text">å›å¤</text>
                          </view>
                        </view>
                      </view>
                    </view>
                  </block>
                </view>
              </view>
            </view>
          </block>
          
          <!-- åŠ è½½æ›´å¤šè¯„è®ºæŒ‰é’® -->
          <view wx:if="{{hasMoreComments && !loadingComments}}" class="comment-load-more">
            <view class="comment-load-more-btn" bindtap="loadMoreComments">
              <text>åŠ è½½æ›´å¤šè¯„è®º</text>
            </view>
          </view>
          
          <!-- åŠ è½½ä¸­æç¤º -->
          <view wx:if="{{loadingComments}}" class="comment-load-more">
            <text class="comments-empty-text">åŠ è½½ä¸­...</text>
          </view>
        </view>
        
        <!-- ç©ºè¯„è®ºæç¤º -->
        <view wx:else class="comments-empty">
          <text class="comments-empty-text">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</text>
        </view>
      </view>

      <!-- åº•éƒ¨é—´è·ï¼Œé¿å…è¢«åº•éƒ¨æ“ä½œæ é®æŒ¡ -->
      <view class="bottom-spacer"></view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ ï¼ˆç‚¹èµã€æ”¶è—ã€è¯„è®ºï¼‰ -->
  <view class="bottom-action-bar">
    <view class="action-input-wrapper" bindtap="focusCommentInput">
      <text class="action-input-placeholder">è¯´ç‚¹ä»€ä¹ˆ...</text>
    </view>
    <view class="action-buttons">
      <view class="action-btn {{liked ? 'liked' : ''}}" bindtap="toggleLike">
        <text class="action-icon">{{liked ? 'â¤ï¸' : 'ğŸ¤'}}</text>
        <text class="action-count">{{likeCount || 0}}</text>
      </view>
      <view class="action-btn {{favorited ? 'favorited' : ''}}" bindtap="toggleFavorite">
        <text class="action-icon">{{favorited ? 'â­' : 'â˜†'}}</text>
        <text class="action-count">{{favoriteCount || 0}}</text>
      </view>
      <view class="action-btn" bindtap="focusCommentInput">
        <text class="action-icon">ğŸ’¬</text>
        <text class="action-count">{{commentsCount || 0}}</text>
      </view>
    </view>
  </view>

  <!-- è¯„è®ºè¾“å…¥æ¡†ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ -->
  <view wx:if="{{showCommentInput}}" class="comment-input-bar">
    <view class="comment-input-wrapper">
      <input 
        id="comment-input"
        class="comment-input"
        placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
        value="{{commentText}}"
        focus="{{commentInputFocus}}"
        bindinput="onCommentInput"
        bindfocus="onCommentFocus"
        bindblur="onCommentBlur"
        confirm-type="send"
        bindconfirm="submitComment"
      />
      <view class="comment-send-btn {{commentText.trim() ? 'active' : ''}} {{submittingComment ? 'submitting' : ''}}" bindtap="submitComment">
        <text wx:if="{{submittingComment}}">å‘é€ä¸­...</text>
        <text wx:else>å‘é€</text>
      </view>
    </view>
  </view>
</view>
