<view class="page {{theme === 'dark' ? 'dark-theme' : ''}}" data-weui-theme="{{theme}}">
  <view class="container">
    <!-- é¡¶éƒ¨æ“ä½œæ  -->
    <view class="header-section">
      <!-- è¿”å›æŒ‰é’®ã€å‘å¸ƒæŒ‰é’®å’Œæ ‡é¢˜å·²éšè— -->
    </view>

    <!-- ä¸»ç¼–è¾‘åŒº -->
    <scroll-view class="editor-container" scroll-y scroll-into-view="{{scrollIntoView}}">
      <!-- åª’ä½“é¢„è§ˆåŒºåŸŸ -->
      <view class="media-section">
        <scroll-view class="media-scroll" scroll-x="true" show-scrollbar="false">
          <view class="media-row">
            <block wx:if="{{mediaList && mediaList.length > 0}}">
              <view 
                wx:for="{{mediaList}}" 
                wx:key="index"
                wx:for-item="media"
                wx:for-index="mediaIndex"
                class="media-item"
              >
                <image 
                  wx:if="{{media.type === 'image'}}"
                  class="media-preview" 
                  src="{{media.url || media}}" 
                  mode="aspectFill"
                ></image>
                <view wx:elif="{{media.type === 'video'}}" class="media-video-wrapper" bindtap="previewVideo" data-index="{{mediaIndex}}">
                  <image 
                    class="media-preview" 
                    src="{{media.poster || media.thumbTempFilePath || media.url}}" 
                    mode="aspectFill"
                  ></image>
                  <view class="media-video-play-icon">â–¶</view>
                </view>
                <view class="media-delete" catchtap="removeMedia" data-index="{{mediaIndex}}">Ã—</view>
              </view>
            </block>
            <view class="media-add-btn" bindtap="showMediaPicker">
              <text class="add-icon">+</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- æ ‡é¢˜è¾“å…¥åŒº -->
      <view class="title-section">
        <input 
          class="title-input {{errors.name ? 'error' : ''}}"
          placeholder="æ·»åŠ æ ‡é¢˜"
          placeholder-style="color: #999;"
          value="{{name}}"
          data-field="name"
          bindinput="onInput"
          bindfocus="onTitleFocus"
          bindblur="onTitleBlur"
          style="color: #333;"
          maxlength="100"
        />
        <view wx:if="{{errors.name}}" class="error-text">{{errors.name}}</view>
      </view>

      <!-- æ­£æ–‡è¾“å…¥åŒº -->
      <view class="content-section">
        <view class="content-header">
          <text class="content-label">æ­£æ–‡</text>
          <view class="fullscreen-btn" bindtap="toggleFullscreen">
            <text class="fullscreen-icon">{{fullscreen ? 'â¤“' : 'â¤¢'}}</text>
            <text class="fullscreen-text">{{fullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±ç¼–è¾‘'}}</text>
          </view>
        </view>
        <editor
          id="content-editor"
          class="content-editor {{fullscreen ? 'fullscreen' : ''}}"
          placeholder="æ·»åŠ æ­£æ–‡"
          bindready="onEditorReady"
          bindinput="onEditorInput"
          bindstatuschange="onEditorStatusChange"
          show-img-size="{{false}}"
          show-img-toolbar="{{false}}"
          show-img-resize="{{false}}"
        />
      </view>

      <!-- åŠŸèƒ½é€‰é¡¹åŒºåŸŸ -->
      <view class="options-section">
        <view class="option-item" bindtap="showCategoryPicker">
          <text class="option-icon">ğŸ“</text>
          <text class="option-label">åˆ†ç±»</text>
          <text wx:if="{{apiNameDisplay || apiName}}" class="option-value">{{apiNameDisplay || apiName}}</text>
          <text wx:else class="option-placeholder">è¯·é€‰æ‹©</text>
          <text class="option-arrow">â€º</text>
        </view>
        <view wx:if="{{errors.apiName}}" class="error-text">{{errors.apiName}}</view>

        <view class="option-item" bindtap="chooseLocation" wx:if="{{!hideContactFields}}">
          <text class="option-icon">ğŸ“</text>
          <text class="option-label">æ ‡è®°åœ°ç‚¹</text>
          <text wx:if="{{address}}" class="option-value">{{address}}</text>
          <text wx:else class="option-placeholder">æ·»åŠ ä½ç½®</text>
          <text class="option-arrow">â€º</text>
        </view>
        <view wx:if="{{errors.address}}" class="error-text">{{errors.address}}</view>

        <view class="option-item" wx:if="{{!hideContactFields}}">
          <text class="option-icon">ğŸ“</text>
          <text class="option-label">è”ç³»æ–¹å¼</text>
          <view class="option-input-wrapper">
            <input 
              class="option-input"
              placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              placeholder-style="color: #999;"
              value="{{phone}}"
              type="number"
              bindinput="onPhoneInput"
              maxlength="20"
            />
          </view>
        </view>
        <view wx:if="{{errors.phone}}" class="error-text">{{errors.phone}}</view>

        <!-- ä»·æ ¼è¾“å…¥ï¼ˆäºŒæ‰‹å¸‚åœºåˆ†ç±»ï¼‰ -->
        <view class="option-item" wx:if="{{isSecondHand}}">
          <text class="option-icon">ğŸ’°</text>
          <text class="option-label">ä»·æ ¼ï¼ˆEGPï¼‰</text>
          <view class="option-input-wrapper">
            <input 
              class="option-input"
              placeholder="è¯·è¾“å…¥ä»·æ ¼"
              placeholder-style="color: #999;"
              value="{{price}}"
              type="digit"
              bindinput="onPriceInput"
              maxlength="20"
            />
          </view>
        </view>

        <!-- ä»·æ ¼ã€æˆ¿é—´æ•°ã€é¢ç§¯è¾“å…¥ï¼ˆç§Ÿæˆ¿é…’åº—åˆ†ç±»ï¼‰ -->
        <view class="option-item" wx:if="{{isRental}}">
          <text class="option-icon">ğŸ’°</text>
          <text class="option-label">ä»·æ ¼ï¼ˆEGPï¼‰</text>
          <view class="option-input-wrapper">
            <input 
              class="option-input"
              placeholder="è¯·è¾“å…¥ä»·æ ¼"
              placeholder-style="color: #999;"
              value="{{price}}"
              type="digit"
              bindinput="onPriceInput"
              maxlength="20"
            />
          </view>
        </view>
        <view class="option-item" wx:if="{{isRental}}">
          <text class="option-icon">ğŸ </text>
          <text class="option-label">æˆ¿é—´æ•°</text>
          <view class="option-input-wrapper">
            <input 
              class="option-input"
              placeholder="è¯·è¾“å…¥æˆ¿é—´æ•°"
              placeholder-style="color: #999;"
              value="{{rooms}}"
              type="number"
              bindinput="onRoomsInput"
              maxlength="10"
            />
          </view>
        </view>
        <view class="option-item" wx:if="{{isRental}}">
          <text class="option-icon">ğŸ“</text>
          <text class="option-label">é¢ç§¯ï¼ˆã¡ï¼‰</text>
          <view class="option-input-wrapper">
            <input 
              class="option-input"
              placeholder="è¯·è¾“å…¥é¢ç§¯"
              placeholder-style="color: #999;"
              value="{{area}}"
              type="digit"
              bindinput="onAreaInput"
              maxlength="20"
            />
          </view>
        </view>

        <view class="option-item">
          <text class="option-icon">ğŸ”’</text>
          <text class="option-label">å…¬å¼€å¯è§</text>
          <text class="option-arrow">â€º</text>
        </view>
      </view>

      <!-- åº•éƒ¨é—´è· -->
      <view class="bottom-spacer" style="height: 100px;"></view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar">
      <view class="draft-btn" bindtap="saveDraft">
        <text>å­˜è‰ç¨¿</text>
      </view>
      <view class="publish-btn-bottom {{saving ? 'publishing' : ''}}" bindtap="saveArticle">
        <text wx:if="{{saving}}">å‘å¸ƒä¸­</text>
        <text wx:else>å‘å¸ƒ</text>
      </view>
    </view>

    <!-- åˆ†ç±»é€‰æ‹©å¼¹çª— -->
    <view wx:if="{{showCategoryModal}}" class="modal-mask" bindtap="hideCategoryPicker">
      <view class="modal-content" catchtap="stopPropagation">
        <view class="modal-header">
          <text class="modal-title">é€‰æ‹©åˆ†ç±»</text>
          <text class="modal-close" bindtap="hideCategoryPicker">Ã—</text>
        </view>
        <scroll-view class="modal-body" scroll-y>
          <block wx:if="{{apiList && apiList.length > 0}}">
            <view 
              wx:for="{{apiList}}" 
              wx:key="apiName"
              class="category-option {{apiName === (item.apiName || item) ? 'selected' : ''}}"
              bindtap="selectCategory"
              data-category="{{item.name || item.apiName || item}}"
            >
              <text>{{item.name || item.apiName || item}}</text>
              <text wx:if="{{apiName === (item.apiName || item)}}" class="check-icon">âœ“</text>
            </view>
          </block>
          <view wx:else class="empty-category">
            <text>æš‚æ— åˆ†ç±»</text>
          </view>
        </scroll-view>
      </view>
    </view>

    <!-- åª’ä½“é€‰æ‹©å¼¹çª— -->
    <view wx:if="{{showMediaPickerModal}}" class="modal-mask" bindtap="hideMediaPicker">
      <view class="media-picker-modal" catchtap="stopPropagation">
        <view class="media-picker-title">é€‰æ‹©åª’ä½“ç±»å‹</view>
        <view class="media-picker-options">
          <view class="media-picker-option" bindtap="insertImage">
            <text class="media-picker-icon">ğŸ“·</text>
            <text class="media-picker-label">å›¾ç‰‡</text>
          </view>
          <view class="media-picker-option" bindtap="insertVideo">
            <text class="media-picker-icon">ğŸ¬</text>
            <text class="media-picker-label">è§†é¢‘</text>
          </view>
        </view>
        <view class="media-picker-cancel" bindtap="hideMediaPicker">å–æ¶ˆ</view>
      </view>
    </view>

    <!-- è§†é¢‘é¢„è§ˆå¼¹çª— -->
    <view wx:if="{{showVideoPreview}}" class="modal-mask" bindtap="hideVideoPreview">
      <view class="video-preview-modal" catchtap="stopPropagation">
        <view class="video-preview-header">
          <text class="video-preview-title">è§†é¢‘é¢„è§ˆ</text>
          <text class="video-preview-close" bindtap="hideVideoPreview">Ã—</text>
        </view>
        <view class="video-preview-content">
          <video 
            wx:if="{{previewVideoUrl}}"
            id="preview-video-player"
            class="video-preview-player"
            src="{{previewVideoUrl}}"
            poster="{{previewVideoPoster}}"
            controls="{{true}}"
            show-center-play-btn="{{true}}"
            enable-play-gesture="{{true}}"
            object-fit="contain"
            autoplay="{{true}}"
          ></video>
        </view>
      </view>
    </view>

    <!-- ä¸Šä¼ è¿›åº¦æç¤º -->
    <view wx:if="{{showUploadProgress}}" class="upload-progress-mask">
      <view class="upload-progress-container">
        <view class="upload-progress-icon">
          <text wx:if="{{uploadType === 'image'}}">ğŸ“·</text>
          <text wx:elif="{{uploadType === 'video'}}">ğŸ¬</text>
          <text wx:else>ğŸ“¤</text>
        </view>
        <view class="upload-progress-text">
          <text wx:if="{{uploadType === 'image'}}">ä¸Šä¼ å›¾ç‰‡ä¸­... ({{uploadCurrent}}/{{uploadTotal}})</text>
          <text wx:elif="{{uploadType === 'video'}}">ä¸Šä¼ è§†é¢‘ä¸­...</text>
          <text wx:else>ä¸Šä¼ ä¸­...</text>
        </view>
        <view class="upload-progress-bar">
          <view class="upload-progress-fill" style="width: {{uploadProgress}}%"></view>
        </view>
        <view class="upload-progress-percent">{{uploadProgress}}%</view>
      </view>
    </view>
  </view>
</view>
