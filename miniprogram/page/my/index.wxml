<view class="page" data-weui-theme="{{theme}}">
  <view class="container">
    <!-- ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
    <view class="user-section">
      <block wx:if="{{isLoggedIn && user}}">
        <view class="user-avatar-wrapper">
          <view class="user-avatar">
            <text class="user-avatar-emoji">{{avatarEmoji}}</text>
          </view>
        </view>
        <view class="user-info">
          <text class="user-name">{{user.name || user.phone || 'ç”¨æˆ·'}}</text>
          <text class="user-phone" wx:if="{{user.phone}}">{{user.phone}}</text>
        </view>
        <button class="logout-btn" bindtap="logout" size="mini" plain>é€€å‡ºç™»å½•</button>
      </block>
      <block wx:else>
        <view class="welcome-section">
          <view class="welcome-icon">ğŸ‘¤</view>
          <text class="welcome-text">æ¬¢è¿ä½¿ç”¨</text>
          <text class="welcome-desc">è¯·ç™»å½•ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
        </view>
      </block>
    </view>

    <!-- ç™»å½•åŒºåŸŸ -->
    <view wx:if="{{!isLoggedIn}}" class="login-section">
      <view class="login-card">
        <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
        <view class="login-mode-tabs">
          <view 
            class="login-mode-tab {{loginMode === 'pin' ? 'active' : ''}}"
            bindtap="switchLoginMode"
            data-mode="pin"
          >
            PINç ç™»å½•
          </view>
          <view 
            class="login-mode-tab {{loginMode === 'code' ? 'active' : ''}}"
            bindtap="switchLoginMode"
            data-mode="code"
          >
            éªŒè¯ç ç™»å½•
          </view>
        </view>

        <!-- ç™»å½•è¡¨å• -->
        <view class="login-form">
          <!-- æ‰‹æœºå·è¾“å…¥ -->
          <view class="form-group">
            <view class="form-label">æ‰‹æœºå·</view>
            <view class="input-wrapper">
              <input 
                class="form-input"
                type="number"
                placeholder="è¯·è¾“å…¥0å¼€å¤´çš„åŸƒåŠæ‰‹æœºå·"
                value="{{phone}}"
                bindinput="onPhoneInput"
                maxlength="11"
                placeholder-class="input-placeholder"
              />
            </view>
          </view>

          <!-- æ˜µç§°è¾“å…¥ï¼ˆå¯é€‰ï¼‰ -->
          <view class="form-group">
            <view class="form-label">
              æ˜µç§°<text class="form-label-optional">ï¼ˆå¯é€‰ï¼‰</text>
            </view>
            <view class="input-wrapper">
              <input 
                class="form-input"
                placeholder="æ–°ç”¨æˆ·æ³¨å†Œæ—¶ä½¿ç”¨"
                value="{{name}}"
                bindinput="onNameInput"
                maxlength="50"
                placeholder-class="input-placeholder"
              />
            </view>
          </view>

          <!-- éªŒè¯ç ç™»å½•ï¼šéªŒè¯ç è¾“å…¥ -->
          <view wx:if="{{loginMode === 'code'}}" class="form-group">
            <view class="form-label">éªŒè¯ç </view>
            <view class="input-wrapper input-wrapper-with-btn">
              <input 
                class="form-input"
                type="number"
                placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç "
                value="{{code}}"
                bindinput="onCodeInput"
                maxlength="6"
                placeholder-class="input-placeholder"
              />
              <button 
                class="code-btn {{codeCountdown > 0 || sendingCode ? 'disabled' : ''}}"
                bindtap="sendCode"
                disabled="{{codeCountdown > 0 || sendingCode}}"
                size="mini"
                plain
              >
                {{codeCountdown > 0 ? codeCountdown + 's' : (sendingCode ? 'å‘é€ä¸­' : 'è·å–éªŒè¯ç ')}}
              </button>
            </view>
          </view>

          <!-- PINç è¾“å…¥ - 4ä½æ•°å­—å¯†ç æ¡†ï¼ˆä¸¤ç§ç™»å½•æ–¹å¼éƒ½éœ€è¦ï¼‰ -->
          <view wx:if="{{loginMode === 'pin'}}" class="form-group">
            <view class="form-label">PINç </view>
            <view class="pin-input-wrapper">
              <!-- éšè—çš„è¾“å…¥æ¡†ï¼Œå®Œå…¨é€æ˜ï¼Œä¸æ˜¾ç¤ºç³»ç»Ÿé”®ç›˜ -->
              <!-- ç”±äºè¾“å…¥æ¡†è¢« pin-boxes è¦†ç›–ï¼Œä¸ä¼šè·å¾—ç„¦ç‚¹ï¼Œç³»ç»Ÿé”®ç›˜ä¸ä¼šå¼¹å‡º -->
              <input 
                class="pin-input"
                type="digit"
                placeholder=""
                value="{{pin}}"
                maxlength="4"
                cursor-spacing="0"
                cursor="{{pinCursor}}"
                disabled="{{true}}"
              />
              <!-- æ˜¾ç¤º4ä¸ªè¾“å…¥æ¡†æ ·å¼ï¼Œç‚¹å‡»æ—¶æ˜¾ç¤ºè‡ªå®šä¹‰é”®ç›˜ -->
              <view class="pin-boxes" bindtap="onPinBoxTap">
                <view class="pin-box {{pin.length >= 1 ? 'filled' : ''}} {{pinFocused && pin.length === 0 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 1}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 2 ? 'filled' : ''}} {{pinFocused && pin.length === 1 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 2}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 3 ? 'filled' : ''}} {{pinFocused && pin.length === 2 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 3}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 4 ? 'filled' : ''}} {{pinFocused && pin.length === 3 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 4}}">â—</text>
                </view>
              </view>
            </view>
          </view>

          <!-- ç™»å½•æŒ‰é’® -->
          <button 
            class="login-btn {{loggingIn ? 'loading' : ''}}"
            bindtap="{{loginMode === 'pin' ? 'loginWithPin' : 'loginWithCode'}}"
            disabled="{{loggingIn}}"
            loading="{{loggingIn}}"
            type="primary"
          >
            {{loggingIn ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}}
          </button>
        </view>
      </view>
    </view>

    <!-- åé¦ˆå»ºè®®åŒºåŸŸ -->
    <view class="feedback-section">
      <view class="section-header">
        <text class="section-title">åé¦ˆå»ºè®®</text>
      </view>
      <view class="feedback-card">
        <view class="feedback-form">
          <!-- åŠŸèƒ½åˆ†ç±»é€‰æ‹© -->
          <view class="form-group">
            <view class="form-label">åŠŸèƒ½åˆ†ç±»</view>
            <picker 
              mode="selector" 
              range="{{feedbackCategories || []}}" 
              range-key="label"
              value="{{feedbackCategoryIndex}}"
              bindchange="onCategoryChange"
            >
              <view class="picker-wrapper">
                <text class="picker-text {{feedbackCategory ? '' : 'placeholder'}}">
                  {{feedbackCategory || 'è¯·é€‰æ‹©åŠŸèƒ½åˆ†ç±»'}}
                </text>
                <text class="picker-arrow">â€º</text>
              </view>
            </picker>
          </view>

          <!-- åé¦ˆå†…å®¹è¾“å…¥ -->
          <view class="form-group">
            <view class="form-label">åé¦ˆå†…å®¹</view>
            <view class="textarea-wrapper">
              <textarea 
                class="feedback-textarea"
                placeholder="è¯·è¾“å…¥æ‚¨çš„åé¦ˆã€å»ºè®®æˆ–éœ€æ±‚ï¼ˆ5-500å­—ï¼‰"
                value="{{feedbackContent}}"
                bindinput="onFeedbackInput"
                maxlength="500"
                show-confirm-bar="{{false}}"
                placeholder-class="textarea-placeholder"
              ></textarea>
              <view class="char-count">{{feedbackContent.length}}/500</view>
            </view>
          </view>

          <!-- æäº¤æŒ‰é’® -->
          <button 
            class="submit-btn {{submitting ? 'loading' : ''}}"
            type="primary"
            bindtap="submitFeedback"
            disabled="{{submitting}}"
            loading="{{submitting}}"
          >
            {{submitting ? 'æäº¤ä¸­...' : 'æäº¤åé¦ˆ'}}
          </button>
        </view>
      </view>
    </view>

    <!-- è°ƒè¯•å·¥å…·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
    <view class="debug-section">
      <button class="debug-btn" bindtap="testApiConnection" size="mini" plain>æµ‹è¯•APIè¿æ¥</button>
    </view>
  </view>

  <!-- è‡ªå®šä¹‰æ•°å­—é”®ç›˜ -->
  <number-keyboard 
    show="{{showKeyboard}}"
    bindinput="onKeyboardInput"
    binddelete="onKeyboardDelete"
    bindclose="hideKeyboard"
  />
</view>
