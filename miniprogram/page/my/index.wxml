<view class="page {{showKeyboard ? 'keyboard-showing' : ''}}" data-weui-theme="{{theme}}">
  <view class="container {{showKeyboard ? 'keyboard-showing' : ''}}">
    <!-- æ²‰æµ¸å¼å¤´éƒ¨åŒºåŸŸ -->
    <view class="header-section">
      <block wx:if="{{isLoggedIn && user}}">
        <!-- è®¾ç½®æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰ -->
        <view class="settings-btn" bindtap="toggleSettingsMenu">
          <text class="settings-icon">âš™ï¸</text>
        </view>
        
        <!-- è®¾ç½®èœå• -->
        <view wx:if="{{showSettingsMenu}}" class="settings-menu" catchtap="closeSettingsMenu">
          <view class="settings-menu-content" catchtap="stopPropagation">
            <view class="settings-menu-item" bindtap="changeNickname">
              <text class="settings-menu-icon">âœï¸</text>
              <text class="settings-menu-text">ä¿®æ”¹æ˜µç§°</text>
            </view>
            <view class="settings-menu-item" bindtap="changePin">
              <text class="settings-menu-icon">ğŸ”</text>
              <text class="settings-menu-text">ä¿®æ”¹PIN</text>
            </view>
            <view class="settings-menu-divider"></view>
            <view class="settings-menu-item" bindtap="logout">
              <text class="settings-menu-icon">ğŸšª</text>
              <text class="settings-menu-text">é€€å‡ºç™»å½•</text>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <view class="user-card">
        <view class="user-avatar-wrapper">
          <view class="user-avatar">
            <text class="user-avatar-emoji">{{avatarEmoji}}</text>
          </view>
        </view>
        <view class="user-info">
          <text class="user-name">{{user.name || user.phone || 'ç”¨æˆ·'}}</text>
          <text class="user-phone" wx:if="{{user.phone}}">{{user.phone}}</text>
        </view>
        </view>
      </block>
      <block wx:else>
        <view class="welcome-section">
          <view class="welcome-icon">ğŸ‘¤</view>
          <text class="welcome-text">æ¬¢è¿ä½¿ç”¨</text>
          <text class="welcome-desc">è¯·ç™»å½•ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½</text>
        </view>
      </block>
    </view>

    <!-- ç™»å½•åŒºåŸŸ -->
    <view wx:if="{{!isLoggedIn}}" class="login-section">
      <view class="login-card">
        <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
        <view class="login-mode-tabs">
          <view 
            class="login-mode-tab {{loginMode === 'pin' ? 'active' : ''}}"
            bindtap="switchLoginMode"
            data-mode="pin"
          >
            PINç ç™»å½•
          </view>
          <view 
            class="login-mode-tab {{loginMode === 'code' ? 'active' : ''}}"
            bindtap="switchLoginMode"
            data-mode="code"
          >
            éªŒè¯ç ç™»å½•
          </view>
        </view>

        <!-- ç™»å½•è¡¨å• -->
        <view class="login-form">
          <!-- æç¤ºä¿¡æ¯ -->
          <view class="login-tip">
            <text class="tip-icon">ğŸ’¡</text>
            <text class="tip-text">æœªæ³¨å†Œçš„æ‰‹æœºå·å°†è‡ªåŠ¨æ³¨å†Œï¼Œè¯·ç‰¢è®°æ‚¨çš„ PIN ç </text>
          </view>
          
          <!-- æ‰‹æœºå·è¾“å…¥ -->
          <view class="form-group">
            <view class="form-label">æ‰‹æœºå·</view>
            <view class="input-wrapper">
              <input 
                class="form-input"
                type="number"
                placeholder="è¯·è¾“å…¥0å¼€å¤´çš„åŸƒåŠæ‰‹æœºå·"
                value="{{phone}}"
                bindinput="onPhoneInput"
                maxlength="11"
                placeholder-class="input-placeholder"
              />
            </view>
          </view>

          <!-- æ˜µç§°è¾“å…¥ï¼ˆå¯é€‰ï¼‰ -->
          <view class="form-group">
            <view class="form-label">
              æ˜µç§°<text class="form-label-optional">ï¼ˆå¯é€‰ï¼‰</text>
            </view>
            <view class="input-wrapper">
              <input 
                class="form-input"
                placeholder="æ–°ç”¨æˆ·æ³¨å†Œæ—¶ä½¿ç”¨"
                value="{{name}}"
                bindinput="onNameInput"
                maxlength="50"
                placeholder-class="input-placeholder"
              />
            </view>
          </view>

          <!-- éªŒè¯ç ç™»å½•ï¼šéªŒè¯ç è¾“å…¥ -->
          <view wx:if="{{loginMode === 'code'}}" class="form-group">
            <view class="form-label">éªŒè¯ç </view>
            <view class="input-wrapper input-wrapper-with-btn">
              <input 
                class="form-input"
                type="number"
                placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç "
                value="{{code}}"
                bindinput="onCodeInput"
                maxlength="6"
                placeholder-class="input-placeholder"
              />
              <button 
                class="code-btn {{codeCountdown > 0 || sendingCode ? 'disabled' : ''}}"
                bindtap="sendCode"
                disabled="{{codeCountdown > 0 || sendingCode}}"
                size="mini"
                plain
              >
                {{codeCountdown > 0 ? codeCountdown + 's' : (sendingCode ? 'å‘é€ä¸­' : 'è·å–éªŒè¯ç ')}}
              </button>
            </view>
          </view>

          <!-- PINç è¾“å…¥ - 4ä½æ•°å­—å¯†ç æ¡†ï¼ˆä¸¤ç§ç™»å½•æ–¹å¼éƒ½éœ€è¦ï¼‰ -->
          <view wx:if="{{loginMode === 'pin'}}" class="form-group pin-form-group" id="pin-input-section">
            <view class="form-label">PINç </view>
            <view class="pin-input-wrapper">
              <!-- éšè—çš„è¾“å…¥æ¡†ï¼Œå®Œå…¨é€æ˜ï¼Œä¸æ˜¾ç¤ºç³»ç»Ÿé”®ç›˜ -->
              <input 
                class="pin-input"
                type="digit"
                placeholder=""
                value="{{pin}}"
                maxlength="4"
                cursor-spacing="0"
                cursor="{{pinCursor}}"
                disabled="{{true}}"
                hold-keyboard="{{false}}"
                adjust-position="{{false}}"
              />
              <!-- æ˜¾ç¤º4ä¸ªè¾“å…¥æ¡†æ ·å¼ï¼Œç‚¹å‡»æ—¶æ˜¾ç¤ºè‡ªå®šä¹‰é”®ç›˜ -->
              <view class="pin-boxes" bindtap="onPinBoxTap">
                <view class="pin-box {{pin.length >= 1 ? 'filled' : ''}} {{pinFocused && pin.length === 0 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 1}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 2 ? 'filled' : ''}} {{pinFocused && pin.length === 1 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 2}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 3 ? 'filled' : ''}} {{pinFocused && pin.length === 2 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 3}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 4 ? 'filled' : ''}} {{pinFocused && pin.length === 3 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 4}}">â—</text>
                </view>
              </view>
            </view>
          </view>
          
          <!-- å›ºå®šå®šä½çš„ PIN è¾“å…¥æ¡†ï¼ˆé”®ç›˜æ˜¾ç¤ºæ—¶ï¼‰ -->
          <view wx:if="{{loginMode === 'pin' && showKeyboard}}" class="pin-input-fixed">
            <view class="pin-fixed-label">PINç </view>
            <view class="pin-input-wrapper">
              <view class="pin-boxes">
                <view class="pin-box {{pin.length >= 1 ? 'filled' : ''}} {{pinFocused && pin.length === 0 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 1}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 2 ? 'filled' : ''}} {{pinFocused && pin.length === 1 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 2}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 3 ? 'filled' : ''}} {{pinFocused && pin.length === 2 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 3}}">â—</text>
                </view>
                <view class="pin-box {{pin.length >= 4 ? 'filled' : ''}} {{pinFocused && pin.length === 3 ? 'focus' : ''}}">
                  <text wx:if="{{pin.length >= 4}}">â—</text>
                </view>
              </view>
            </view>
          </view>

          <!-- ç™»å½•æŒ‰é’® -->
          <button 
            class="login-btn {{loggingIn ? 'loading' : ''}}"
            bindtap="{{loginMode === 'pin' ? 'loginWithPin' : 'loginWithCode'}}"
            disabled="{{loggingIn}}"
            loading="{{loggingIn}}"
            type="primary"
          >
            {{loggingIn ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}}
          </button>
        </view>
      </view>
    </view>

    <!-- æ•°æ®ç»Ÿè®¡åŒºåŸŸï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{isLoggedIn && user}}" class="stats-section">
      <view class="stats-card">
        <view class="stat-item" bindtap="navigateToMyLikes">
          <view class="stat-number">{{likesCount}}</view>
          <view class="stat-label">æˆ‘çš„å–œæ¬¢</view>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item" bindtap="navigateToMyFavorites">
          <view class="stat-number">{{favoritesCount}}</view>
          <view class="stat-label">æˆ‘çš„æ”¶è—</view>
        </view>
      </view>
    </view>

    <!-- åŠŸèƒ½åˆ—è¡¨åŒºåŸŸï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{isLoggedIn && user}}" class="menu-section">
      <view class="menu-card">
        <view class="menu-item" bindtap="navigateToMyComments">
          <view class="menu-item-left">
            <text class="menu-icon">ğŸ’¬</text>
            <text class="menu-text">æˆ‘çš„è¯„è®º</text>
          </view>
          <view class="menu-item-right">
          <text class="menu-arrow">â€º</text>
          </view>
        </view>
        <view class="menu-item" bindtap="navigateToMyMessages">
          <view class="menu-item-left">
            <text class="menu-icon">ğŸ””</text>
            <text class="menu-text">æˆ‘çš„æ¶ˆæ¯</text>
          </view>
          <view class="menu-item-right">
            <!-- æ˜¾ç¤ºçº¢è‰²+æ•°å­—æ ¼å¼ -->
            <view wx:if="{{hasUnreadMessage === true || messagesUnreadCount > 0}}" class="menu-badge badge-with-plus">
              <text class="menu-badge-plus">+</text>
              <text class="menu-badge-text">{{messagesUnreadCount > 99 ? '99+' : messagesUnreadCount}}</text>
          </view>
          <text class="menu-arrow">â€º</text>
          </view>
        </view>
        <view class="menu-item {{feedbackButtonActive ? 'active' : ''}}" bindtap="showFeedbackForm">
          <view class="menu-item-left">
            <text class="menu-icon">ğŸ’¡</text>
            <text class="menu-text">åŠŸèƒ½åé¦ˆ</text>
          </view>
          <view class="menu-item-right">
          <text class="menu-arrow">â€º</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åé¦ˆè¡¨å•åŒºåŸŸï¼ˆä»…ç™»å½•åæ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{isLoggedIn && user && showFeedbackForm}}" class="feedback-section">
      <view class="feedback-card">
        <view class="feedback-form">
          <!-- åé¦ˆç±»å‹é€‰æ‹© -->
          <view class="form-group">
            <view class="form-label">åé¦ˆç±»å‹</view>
            <view class="feedback-type-selector">
              <view 
                class="type-option {{feedbackType === 'feedback' ? 'active' : ''}}"
                bindtap="onFeedbackTypeChange"
                data-type="feedback"
              >
                <text class="type-icon">ğŸ’¡</text>
                <text class="type-text">åé¦ˆå»ºè®®</text>
              </view>
              <view 
                class="type-option {{feedbackType === 'complaint' ? 'active' : ''}}"
                bindtap="onFeedbackTypeChange"
                data-type="complaint"
              >
                <text class="type-icon">âš ï¸</text>
                <text class="type-text">æŠ•è¯‰</text>
              </view>
            </view>
          </view>

          <!-- åŠŸèƒ½åˆ†ç±»é€‰æ‹© -->
          <view class="form-group">
            <view class="form-label">åŠŸèƒ½åˆ†ç±»</view>
            <picker 
              mode="selector" 
              range="{{feedbackCategories || []}}" 
              range-key="label"
              value="{{feedbackCategoryIndex}}"
              bindchange="onCategoryChange"
            >
              <view class="picker-wrapper">
                <text class="picker-text {{feedbackCategory ? '' : 'placeholder'}}">
                  {{feedbackCategory || 'è¯·é€‰æ‹©åŠŸèƒ½åˆ†ç±»'}}
                </text>
                <text class="picker-arrow">â€º</text>
              </view>
            </picker>
          </view>

          <!-- åé¦ˆå†…å®¹è¾“å…¥ -->
          <view class="form-group">
            <view class="form-label">åé¦ˆå†…å®¹</view>
            <view class="textarea-wrapper">
              <textarea 
                class="feedback-textarea"
                placeholder="{{feedbackType === 'feedback' ? 'è¯·è¾“å…¥æ‚¨çš„åé¦ˆã€å»ºè®®æˆ–éœ€æ±‚ï¼ˆ1-100å­—ï¼‰' : 'è¯·è¾“å…¥æŠ•è¯‰å†…å®¹ï¼ˆ1-100å­—ï¼‰'}}"
                value="{{feedbackContent}}"
                bindinput="onFeedbackInput"
                maxlength="100"
                show-confirm-bar="{{false}}"
                placeholder-class="textarea-placeholder"
              ></textarea>
              <view class="char-count">{{feedbackContent.length}}/100</view>
            </view>
          </view>

          <!-- æäº¤æŒ‰é’® -->
          <button 
            class="submit-btn {{submitting ? 'loading' : ''}}"
            type="primary"
            bindtap="submitFeedback"
            disabled="{{submitting}}"
            loading="{{submitting}}"
          >
            {{submitting ? 'æäº¤ä¸­...' : (feedbackType === 'feedback' ? 'æäº¤åé¦ˆ' : 'æäº¤æŠ•è¯‰')}}
          </button>
        </view>
      </view>
    </view>

    <!-- è°ƒè¯•å·¥å…·ï¼ˆå¼€å‘ç¯å¢ƒï¼‰ -->
    <view class="debug-section">
      <button class="debug-btn" bindtap="testApiConnection" size="mini" plain>æµ‹è¯•APIè¿æ¥</button>
    </view>
  </view>

  <!-- è‡ªå®šä¹‰æ•°å­—é”®ç›˜ -->
  <number-keyboard 
    show="{{showKeyboard}}"
    bindinput="onKeyboardInput"
    binddelete="onKeyboardDelete"
    bindclose="hideKeyboard"
  />

  <!-- PINè¾“å…¥å¼¹çª— -->
  <view wx:if="{{showPinInputModal}}" class="pin-input-modal" catchtap="closePinInputModal">
    <view class="pin-input-modal-content" catchtap="stopPropagation">
      <view class="pin-input-modal-header">
        <text class="pin-input-modal-title">{{pinInputTitle}}</text>
        <view class="pin-input-modal-close" bindtap="closePinInputModal">
          <text>âœ•</text>
        </view>
      </view>
      <view class="pin-input-modal-body">
        <view class="pin-input-form">
          <view class="form-label">PINç </view>
          <view class="pin-input-wrapper-modal">
            <input 
              class="pin-input-field"
              type="digit"
              placeholder="{{pinInputPlaceholder}}"
              value="{{pinInputValue}}"
              maxlength="4"
              bindinput="onPinInputChange"
              bindfocus="onPinInputFocus"
              auto-focus="{{true}}"
              placeholder-class="pin-input-placeholder"
            />
          </view>
          <view class="pin-input-hint">
            <text>è¯·è¾“å…¥4ä½æ•°å­—</text>
          </view>
        </view>
      </view>
      <view class="pin-input-modal-footer">
        <button class="pin-input-btn-cancel" bindtap="closePinInputModal">å–æ¶ˆ</button>
        <button 
          class="pin-input-btn-confirm {{pinInputValue.length === 4 ? 'active' : ''}}" 
          bindtap="confirmPinInput"
          disabled="{{pinInputValue.length !== 4}}"
        >
          ç¡®è®¤
        </button>
      </view>
    </view>
  </view>
</view>
