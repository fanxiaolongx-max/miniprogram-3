<view class="page" data-weui-theme="light" style="width: 100%; overflow-x: hidden;">
  <view class="container">
    <!-- 搜索和筛选区域 -->
    <view class="filter-section">
      <view class="search-box">
        <input 
          class="search-input"
          placeholder="搜索应用..."
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
        />
        <text class="search-icon">🔍</text>
      </view>
      <view class="category-tags">
        <view 
          wx:for="{{categories}}" 
          wx:key="*this"
          class="category-tag {{selectedCategory === (item === '全部' ? '' : item) ? 'active' : ''}}"
          bindtap="selectCategory"
          data-category="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>

    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <text class="loading-text">加载中...</text>
    </view>

    <!-- 错误状态 -->
    <view wx:elif="{{error}}" class="error-container">
      <text class="error-text">获取数据失败，请稍后重试</text>
      <button class="retry-btn" bindtap="retry">重试</button>
    </view>

    <!-- 瀑布流列表 -->
    <block wx:else>
      <view wx:if="{{filteredItems.length === 0}}" class="empty-container">
        <text class="empty-text">暂无应用信息</text>
      </view>
      <view wx:else class="waterfall-container">
        <view class="waterfall-column">
          <view 
            wx:for="{{filteredItems}}" 
            wx:key="id"
            wx:for-item="item"
            wx:for-index="index"
            wx:if="{{index % 2 === 0}}"
            class="waterfall-item"
            bindtap="viewDetail"
            data-item="{{item}}"
          >
            <view class="item-image-wrapper">
              <image 
                class="item-image" 
                src="{{item.image}}" 
                mode="aspectFill"
                binderror="onImageError"
                data-index="{{index}}"
                data-id="{{item.id}}"
              ></image>
              <view wx:if="{{!item.published}}" class="draft-badge">草稿</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.name}}</view>
              <view wx:if="{{item.description}}" class="item-description">{{item.description}}</view>
              <view wx:if="{{item.latitude && item.longitude || item.phone}}" class="item-footer">
                <view wx:if="{{item.latitude && item.longitude}}" class="location-btn" catchtap="openLocation" data-item="{{item}}">
                  <text class="location-icon">📍</text>
                  <text class="location-text">导航</text>
                </view>
                <view wx:if="{{item.phone}}" class="phone-btn" catchtap="makePhoneCall" data-item="{{item}}">
                  <text class="phone-icon">📞</text>
                  <text class="phone-text">呼叫</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view class="waterfall-column">
          <view 
            wx:for="{{filteredItems}}" 
            wx:key="id"
            wx:for-item="item"
            wx:for-index="index"
            wx:if="{{index % 2 === 1}}"
            class="waterfall-item"
            bindtap="viewDetail"
            data-item="{{item}}"
          >
            <view class="item-image-wrapper">
              <image 
                class="item-image" 
                src="{{item.image}}" 
                mode="aspectFill"
                binderror="onImageError"
                data-index="{{index}}"
                data-id="{{item.id}}"
              ></image>
              <view wx:if="{{!item.published}}" class="draft-badge">草稿</view>
            </view>
            <view class="item-content">
              <view class="item-title">{{item.name}}</view>
              <view wx:if="{{item.description}}" class="item-description">{{item.description}}</view>
              <view wx:if="{{item.latitude && item.longitude || item.phone}}" class="item-footer">
                <view wx:if="{{item.latitude && item.longitude}}" class="location-btn" catchtap="openLocation" data-item="{{item}}">
                  <text class="location-icon">📍</text>
                  <text class="location-text">导航</text>
                </view>
                <view wx:if="{{item.phone}}" class="phone-btn" catchtap="makePhoneCall" data-item="{{item}}">
                  <text class="phone-icon">📞</text>
                  <text class="phone-text">呼叫</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
      <!-- 加载更多按钮 -->
      <view wx:if="{{hasMore && !loadingMore && !preloading && !loading}}" class="load-more-container">
        <text class="load-more-btn" bindtap="loadMore">加载更多</text>
      </view>
      <!-- 加载中提示 -->
      <view wx:if="{{loadingMore || preloading}}" class="loading-more">
        <text class="loading-text">加载中...</text>
      </view>
      <!-- 没有更多提示 -->
      <view wx:if="{{!hasMore && items.length > 0}}" class="no-more">
        <text class="no-more-text">没有更多数据了</text>
      </view>
    </block>
  </view>
</view>
